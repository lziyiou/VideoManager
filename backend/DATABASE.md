# 数据库初始化说明

## 概述

本项目使用 SQLite 数据库存储视频管理系统的数据，包括视频信息、标签、标签分类和系统设置。

## 数据库结构

### 主要表结构

1. **videos** - 视频信息表
   - 存储视频文件的基本信息（文件名、路径、大小、时长等）
   - 包含缩略图路径、收藏状态、网页播放状态等字段

2. **tags** - 标签表
   - 存储视频标签信息
   - 关联到标签分类（category_id）

3. **tag_categories** - 标签分类表
   - 存储标签的分类信息
   - 包含分类名称、颜色、排序等字段

4. **video_tag** - 视频标签关联表
   - 多对多关系表，关联视频和标签

5. **settings** - 系统设置表
   - 存储系统配置信息

## 数据库初始化

### 自动初始化

当应用启动时，数据库会自动初始化：

1. **应用启动时**：`main.py` 导入 `database.py` 模块
2. **模块加载时**：`database.py` 中的 `init_db()` 函数自动执行
3. **表创建**：使用 `Base.metadata.create_all()` 创建所有表结构

### 手动初始化

如果需要手动初始化或重置数据库，可以使用提供的脚本：

```bash
# 初始化数据库（创建表和默认数据）
python init_database.py

# 重置数据库（删除所有数据后重新初始化）
python init_database.py --reset
```

### 初始化内容

手动初始化脚本会创建：

1. **数据库表结构**
2. **默认标签分类**：
   - 通用（蓝色）
   - 类型（绿色）
   - 主题（橙色）
   - 质量（红色）
3. **默认系统设置**：
   - root_directory: 根目录路径
   - thumbnail_quality: 缩略图质量
   - max_thumbnail_size: 最大缩略图尺寸

## 数据库文件

- **文件位置**：`backend/video_manager.db`
- **文件类型**：SQLite 数据库文件
- **版本控制**：已添加到 `.gitignore`，不会被提交到 Git

## 模型定义

所有数据库模型定义在 `app/models/` 目录下：

- `setting.py` - 系统设置模型和 Base 定义
- `video.py` - 视频模型
- `tag.py` - 标签模型和视频-标签关联表
- `tag_category.py` - 标签分类模型

## 注意事项

1. **数据库文件**：`video_manager.db` 文件应该在项目部署时生成，不应提交到版本控制
2. **模型导入**：`database.py` 必须导入所有模型类，确保 `create_all()` 能创建所有表
3. **数据迁移**：如果修改了模型结构，需要删除现有数据库文件或使用重置脚本
4. **备份**：重要数据应定期备份，重置操作会删除所有数据

## 故障排除

### 表未创建

如果发现某些表没有被创建，检查：

1. `database.py` 是否导入了所有模型类
2. 模型类是否正确继承了 `Base`
3. 模型类是否定义了 `__tablename__`

### 数据库锁定

如果遇到数据库锁定问题：

1. 确保所有数据库连接都正确关闭
2. 重启应用程序
3. 如果问题持续，删除数据库文件并重新初始化

### 外键约束错误

如果遇到外键约束错误：

1. 确保相关的表都已创建
2. 检查外键字段的数据类型是否匹配
3. 确保引用的记录存在